<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Task Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      body { background:#f2f2f2; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
      .panel { max-width:720px; margin:24px auto; background:#fff; border:1px solid #e6e6e6; }
      .panel-header { padding:14px; text-align:center; font-weight:700; border-bottom:1px solid #e9ecef; }
      .panel-body { padding:14px; }
      table { width:100%; }
      .actions a, .actions form { display:inline-block; }
    </style>
  </head>
  <body>
    <div class="panel">
      <div class="panel-header">Task Tracker</div>
      <div class="panel-body">
        <div class="d-flex mb-3">
          <form th:action="@{/tasks}" class="me-2" method="get">
            <input class="form-control" name="q" placeholder="Search" th:value="${q}" style="width:240px; display:inline-block;">
          </form>
          <div class="ms-auto">
            <a th:href="@{/tasks/new}" class="btn btn-primary">New Task</a>
          </div>
        </div>

        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th style="width:50px">ID</th>
              <th>Title</th>
              <th>Due Date</th>
              <th>Status</th>
              <th style="width:160px">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr th:if="${#lists.isEmpty(tasks)}">
              <td colspan="5" class="text-center text-muted">No tasks yet.</td>
            </tr>
            <tr th:each="t : ${tasks}">
              <td th:text="${t.id}"></td>
              <td>
                <a th:href="@{/tasks/{id}(id=${t.id})}" th:text="${t.title}"></a>
              </td>
              <td th:text="${t.dueDate != null ? #temporals.format(t.dueDate, 'dd-MMM-yyyy') : ''}"></td>
              <td th:text="${t.done} ? 'Done' : 'Open'"></td>
              <td class="actions">
                <a th:href="@{/tasks/{id}/edit(id=${t.id})}" class="btn btn-sm btn-outline-secondary">Edit</a>
                <form th:action="@{/tasks/{id}/toggle(id=${t.id})}" method="post" style="display:inline-block; margin:0 6px;">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <button type="submit" class="btn btn-sm btn-outline-primary" th:text="${t.done} ? 'Mark Open' : 'Mark Done'"></button>
                </form>
                <form th:action="@{/tasks/{id}/delete(id=${t.id})}" method="post" style="display:inline-block; margin:0 0 0 6px;" class="delete-form" data-title="[[${t.title}]]">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> <span class="d-none d-sm-inline">Delete</span></button>
                </form>
              </td>
            </tr>
          </tbody>
        </table>

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Delete confirmation modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="confirmDeleteMessage">Are you sure you want to delete this task?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger btn-sm">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const modalEl = document.getElementById('confirmDeleteModal');
        const bsModal = new bootstrap.Modal(modalEl);
        let currentForm = null;
        document.querySelectorAll('.delete-form').forEach(f => {
          f.addEventListener('submit', function(e){
            e.preventDefault();
            currentForm = this;
            const title = this.getAttribute('data-title') || 'this item';
            document.getElementById('confirmDeleteMessage').textContent = 'Delete "' + title + '"?';
            bsModal.show();
          });
        });
        document.getElementById('confirmDeleteBtn').addEventListener('click', function(){
          if (currentForm) currentForm.submit();
        });
      })();
    </script>
  </body>
</html>